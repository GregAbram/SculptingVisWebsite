from __future__ import print_function
import os, sys
from glob import glob
from bibtexparser import load

def eprint(*args, **kwargs):
    print(*args, file=sys.stderr, **kwargs)

top = [
'<!DOCTYPE html>',
'<html>',
'  <head>',
'    <meta charset="utf-8">',
'    <meta http-equiv="X-UA-Compatible" content="IE=edge">',
'    <title>Publications | Sculpting Visualizations</title>',
'    <meta name="description" content="">',
'    <meta name="viewport" content="width=device-width, initial-scale=1">',
'    <link rel="stylesheet" href="https://necolas.github.io/normalize.css/8.0.1/normalize.css">',
'    <link rel="stylesheet" href="../css/style.css">',
'  </head>',
'  <body>',
'    {% include "njk/header.html" %}',
'    <publication-body>'
]

bottom = [
'    </publication-body>',
'    {% include "njk/footer.html" %}',
'    <script src="" async defer></script>',
'  </body>',
'</html>'
]

def add_pub(year, title):
  print('        <pub id="%s %s">' % (year, title))
  print('          <div class=pubimg>')
  print('            <img  class=pubimg src="../publications/%s/%s/image.png" alt="%s"/>' % (year, title, title))
  print('          </div>')
  print('          <div class="pubtxt">')
  print('            <p>')

  cfile = 'publications/%s/%s/pub.bib' % (year, title)
  if os.path.isfile(cfile):

    with open(cfile) as cf:
      citation = load(cf).entries[0]

    if 'author' in citation:
      print('<span class=authors>%s</span>' % citation['author'])
    else:
      print('(no authors)')

    if 'year' in citation:
      print('(%s).' % citation['year'])
    else:
      print('.')

    if 'title' in citation:
      title = citation['title']

    print('<span class=title>')
    if 'url' in citation:
      print('<a href="%s" target="_blank">%s</a>' % (citation['url'], title))
    else:
      print('%s' % title)
    print('</span>')

    print('<span class=source>')

    if 'journal' in citation:
      print(',%s' % citation['journal'])

    if 'volume' in citation:
      print(', vol. %s' % (citation['volume']))

    if 'number' in citation:
      print(', no. %s' % (citation['number']))

    if 'pages' in citation:
      print(', (%s)' % (citation['pages']))

    print('</span>')

  else:
    print('<span class=pub_title>%s</span>. No citation.' % title)

  print('            </p>')
  print('          </div>')
  print('        </pub>')

print("\n".join(top))

for year in sorted([i.split('/')[-1] for i in glob('publications/*')]):

  eprint('YEAR %s' % year)

  print('            <year>')
  print('              <label><h1>%s</h1></label>' % year)
  print('              <pubs>')

  titles = sorted([i.split('/')[-1] for i in glob('publications/%s/*' % year)])
  if len(titles) > 0:
    for title in titles:
      eprint('TITLE %s' % title)
      add_pub(year, title)

  print('              </pubs>')
  print('            </year>')

print("\n".join(bottom))
